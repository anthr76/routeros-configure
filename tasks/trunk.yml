---

- name: configure trunks
  community.routeros.command:
  commands:
    - /interface bridge port add bridge=bridge interface={{ loop_port }}
    - /interface bridge vlan set bridge=bridge tagged={{ loop_port }} [find vlan-ids={{ loop_vlan }}]
  loop: "{{ interface.trunk.phys }}"
  vars:
    loop_port: "{{ item.phys.port }}"
    loop_vlan: "{{ item.phys.pvid | dict2items }}"

- name: set vlan security
  community.routeros.command:
  commands:
      - /interface bridge port set bridge=bridge ingress-filtering=yes frame-types=admit-only-vlan-tagged [find interface={{ loop_port }}]
  with_items: "{{ interface.trunk.phys }}"
  vars:
    loop_port: "{{ item.phys.port }}"
  when:
    - item.phys.vlan-secured
